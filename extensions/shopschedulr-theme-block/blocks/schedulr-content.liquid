{% comment %}
  ShopSchedulr block: Automatically finds and displays the active schedulable entity
  that matches the Position ID and is currently within its scheduled date/time range.
  If multiple matches, displays the one with the most recent start date/time.
{% endcomment %}

{% assign now_ts = 'now' | date: '%s' %}
{% assign position_id = block.settings.position_id | default: '' %}

{% comment %} Get all metaobjects of type schedulable_entity {% endcomment %}
{% assign all_entries = shop.metaobjects.schedulable_entity.values %}

{% comment %} Find matching entries: position_id matches, start_at <= NOW, end_at > NOW {% endcomment %}
{% assign matching_entries = blank | split: ',' %}
{% for entry in all_entries %}
  {% assign fields = entry.fields %}
  {% assign entry_pos = fields.position_id.value | default: '' %}
  {% assign start_at_value = fields.start_at.value %}
  {% assign end_at_value = fields.end_at.value %}
  
  {% if start_at_value != blank and end_at_value != blank %}
    {% assign start_ts = start_at_value | date: '%s' %}
    {% assign end_ts = end_at_value | date: '%s' %}
    
    {% if entry_pos == position_id and now_ts >= start_ts and now_ts < end_ts %}
      {% assign matching_entries = matching_entries | push: entry %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %} If multiple matches, sort by start_at descending and take the first (most recent start) {% endcomment %}
{% assign selected_entry = null %}
{% if matching_entries.size > 0 %}
  {% if matching_entries.size == 1 %}
    {% assign selected_entry = matching_entries[0] %}
  {% else %}
    {% comment %} Sort by start_at descending - find the one with the most recent start {% endcomment %}
    {% assign latest_start_ts = 0 %}
    {% for entry in matching_entries %}
      {% assign entry_start_ts = entry.fields.start_at.value | date: '%s' %}
      {% if entry_start_ts > latest_start_ts %}
        {% assign latest_start_ts = entry_start_ts %}
        {% assign selected_entry = entry %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

{% comment %} Display the selected entry {% endcomment %}
{% if selected_entry != null %}
  {% assign fields = selected_entry.fields %}
  {% assign desktop_banner = fields.desktop_banner.value %}
  {% assign mobile_banner = fields.mobile_banner.value %}
  {% assign target_url = fields.target_url.value %}
  {% assign headline = fields.headline.value %}
  {% assign button_text = fields.button_text.value %}
  {% assign description = fields.description.value %}
  
  <div class="shopschedulr" {{ block.shopify_attributes }}>
    <div class="shopschedulr__banner shopschedulr__banner--{{ block.settings.display_style | default: 'below' }}" data-handle="{{ selected_entry.handle }}">
          {% if desktop_banner or mobile_banner %}
            <div class="shopschedulr__banner-image">
              {% if desktop_banner %}
                <img 
                  src="{{ desktop_banner.url }}" 
                  alt="{{ desktop_banner.alt | default: fields.title.value }}"
                  class="shopschedulr__image shopschedulr__image--desktop"
                  width="{{ desktop_banner.width }}"
                  height="{{ desktop_banner.height }}"
                  loading="lazy"
                >
              {% endif %}
              {% if mobile_banner %}
                <img 
                  src="{{ mobile_banner.url }}" 
                  alt="{{ mobile_banner.alt | default: fields.title.value }}"
                  class="shopschedulr__image shopschedulr__image--mobile"
                  width="{{ mobile_banner.width }}"
                  height="{{ mobile_banner.height }}"
                  loading="lazy"
                >
              {% elsif desktop_banner %}
                {% comment %}Fallback to desktop image on mobile if no mobile banner{% endcomment %}
                <img 
                  src="{{ desktop_banner.url }}" 
                  alt="{{ desktop_banner.alt | default: fields.title.value }}"
                  class="shopschedulr__image shopschedulr__image--mobile shopschedulr__image--fallback"
                  width="{{ desktop_banner.width }}"
                  height="{{ desktop_banner.height }}"
                  loading="lazy"
                >
              {% endif %}
            </div>
          {% endif %}
          
          <div class="shopschedulr__banner-content">
            {% if fields.title.value != blank %}
              <h2 class="shopschedulr__title">{{ fields.title.value }}</h2>
            {% endif %}
            
            {% if headline != blank %}
              <h3 class="shopschedulr__headline">{{ headline }}</h3>
            {% endif %}
            
            {% if description != blank %}
              <div class="shopschedulr__description">{{ description }}</div>
            {% endif %}
            
            {% if target_url != blank and button_text != blank %}
              <a href="{{ target_url }}" class="shopschedulr__button">{{ button_text }}</a>
            {% elsif target_url != blank %}
              <a href="{{ target_url }}" class="shopschedulr__button">{{ block.settings.default_button_text | default: 'Learn More' }}</a>
            {% endif %}
          </div>
        </div>
    </div>
{% else %}
  {% if block.settings.show_empty_state %}
    <div class="shopschedulr" {{ block.shopify_attributes }}>
      <div class="shopschedulr__empty">{{ block.settings.empty_state_text }}</div>
    </div>
  {% endif %}
{% endif %}


<style>
  .shopschedulr {
    width: 100%;
    margin: 20px 0;
  }
  
  .shopschedulr__banner {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
  }
  
  .shopschedulr__banner-image {
    position: relative;
    width: 100%;
    line-height: 0;
  }
  
  .shopschedulr__image {
    display: block;
    width: 100%;
    height: auto;
    object-fit: cover;
  }
  
  .shopschedulr__image--desktop {
    display: block;
  }
  
  .shopschedulr__image--mobile {
    display: none;
  }
  
  @media (max-width: 768px) {
    .shopschedulr__image--desktop {
      display: none;
    }
    
    .shopschedulr__image--mobile {
      display: block;
    }
  }
  
  .shopschedulr__banner-content {
    padding: 30px 20px;
    text-align: center;
    background: rgba(255, 255, 255, 0.95);
  }
  
  .shopschedulr__title {
    margin: 0 0 10px 0;
    font-size: 2.5em;
    font-weight: bold;
    color: #2c3e50;
    line-height: 1.2;
  }
  
  @media (max-width: 768px) {
    .shopschedulr__title {
      font-size: 2em;
    }
  }
  
  .shopschedulr__headline {
    margin: 0 0 15px 0;
    font-size: 1.8em;
    font-weight: 600;
    color: #34495e;
    line-height: 1.2;
  }
  
  @media (max-width: 768px) {
    .shopschedulr__headline {
      font-size: 1.4em;
    }
  }
  
  .shopschedulr__description {
    margin: 0 0 20px 0;
    font-size: 1.1em;
    color: #555;
    line-height: 1.6;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }
  
  @media (max-width: 768px) {
    .shopschedulr__description {
      font-size: 1em;
    }
  }
  
  .shopschedulr__button {
    display: inline-block;
    padding: 12px 30px;
    background-color: #667eea;
    color: white !important;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 1em;
    transition: background-color 0.3s ease, transform 0.2s ease;
    cursor: pointer;
  }
  
  .shopschedulr__button:hover {
    background-color: #5568d3;
    transform: translateY(-2px);
    text-decoration: none;
  }
  
  .shopschedulr__button:active {
    transform: translateY(0);
  }
  
  .shopschedulr__empty {
    padding: 40px 20px;
    text-align: center;
    color: #999;
    font-style: italic;
  }
  
  /* Overlay content on image variant */
  .shopschedulr__banner--overlay .shopschedulr__banner-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
    color: white;
    text-align: left;
    padding: 40px;
  }
  
  .shopschedulr__banner--overlay .shopschedulr__title,
  .shopschedulr__banner--overlay .shopschedulr__headline,
  .shopschedulr__banner--overlay .shopschedulr__description {
    color: white;
  }
  
  .shopschedulr__banner--overlay .shopschedulr__button {
    background-color: white;
    color: #667eea !important;
  }
  
  .shopschedulr__banner--overlay .shopschedulr__button:hover {
    background-color: #f0f0f0;
  }
</style>

{% schema %}
{
  "name": "ShopSchedulr Banner",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "position_id",
      "label": "Position ID",
      "info": "The position ID to filter scheduled content by",
      "default": "homepage_banner"
    },
    {
      "type": "select",
      "id": "display_style",
      "label": "Display style",
      "options": [
        {
          "value": "below",
          "label": "Content below image"
        },
        {
          "value": "overlay",
          "label": "Content overlay on image"
        }
      ],
      "default": "below"
    },
    {
      "type": "text",
      "id": "default_button_text",
      "label": "Default button text",
      "info": "Text to show on button if no button text is set in the entry",
      "default": "Learn More"
    },
    {
      "type": "checkbox",
      "id": "show_empty_state",
      "label": "Show empty state",
      "info": "Show a message when no entries match",
      "default": false
    },
    {
      "type": "text",
      "id": "empty_state_text",
      "label": "Empty state text",
      "default": "Nothing is scheduled for this spot."
    }
  ]
}
{% endschema %}

